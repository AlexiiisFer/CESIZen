{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="bg-[#F5F7FA] py-12">
    <div class="container mx-auto px-4">
        <h1 class="text-4xl font-bold text-center mb-10">Gestion des <span class="text-green-500">Activit√©s</span></h1>
    </div>
</div>
<div class="container mx-auto my-8">

    <div class="flex justify-between items-center mb-6">
        <button onclick="openAddActivityModal()"
          class="flex items-center gap-2 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg shadow transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"
            stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
          </svg>
          Ajouter une activit√©
        </button>
      </div>


      <form method="get" class="mb-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">

        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold text-gray-500">Liste des activit√©s</h2>
        </div>
    
        <div class="flex items-center gap-2 w-full md:w-auto">
          <input type="text" name="search" placeholder="Rechercher par titre..." value="{{ search|default_if_none:'' }}"
            class="border rounded-lg px-4 py-2 w-full md:w-64 shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500" />
          <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
            üîç Rechercher
          </button>
        </div>
      </form>

    





    <!-- üìã Tableau -->
    <div class="overflow-x-auto bg-white rounded-lg shadow">
        <table class="min-w-full text-sm">
            <thead class="bg-green-600 text-white uppercase text-xs tracking-wider">
                <tr>
                    <th class="px-4 py-3 text-left">Titre</th>
                    <th class="px-4 py-3 text-left">Cat√©gorie</th>
                    <th class="px-4 py-3 text-left">Statut</th>
                    <th class="px-4 py-3 text-center">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {% for activity in page_obj %}
                <tr class="hover:bg-gray-50 transition">
                    <td class="px-4 py-3 font-medium text-gray-800">{{ activity.title }}</td>
                    <td class="px-4 py-3 text-gray-600">{{ activity.category.name }}</td>
                    <td class="px-4 py-3 text-gray-600">
                        {% if activity.is_active %}
                        <span
                            class="inline-block px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs">Active</span>
                        {% else %}
                        <span
                            class="inline-block px-2 py-1 bg-red-100 text-red-700 rounded-full text-xs">D√©sactiv√©e</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-center">
                        <div class="flex justify-center gap-2">

                            <div class="relative group">
                                <button class="text-blue-600 hover:text-blue-800" data-id="{{ activity.id }}"
                                    data-title="{{ activity.title|escape }}"
                                    data-description="{{ activity.description|escape }}"
                                    data-video="{{ activity.video_url|default:''|escape }}"
                                    data-category="{{ activity.category.id }}"
                                    data-active="{{ activity.is_active|yesno:'true,false' }}"
                                    data-image="{% if activity.image %}{{ activity.image.url }}{% else %}''{% endif %}"
                                    onclick="openEditModalFromData(this)">

                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M11 4H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2v-5M18.5 2.5l2 2L12 13l-3 1 1-3 8.5-8.5z" />
                                    </svg>
                                </button>
                            </div>



                            <!-- üîÅ Activer/D√©sactiver -->
                            <form method="post" action="{% url 'toggle_activity' activity.id %}" class="relative group">

                                {% csrf_token %}
                                <button type="submit"
                                    class="{% if user.is_active %}text-yellow-600 hover:text-yellow-800{% else %}text-green-600 hover:text-green-700{% endif %}">
                                    {% if activity.is_active %}
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    {% else %}
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                                    </svg>
                                    {% endif %}
                                </button>
                                <div
                                    class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 px-2 py-1 rounded bg-gray-800 text-white text-xs whitespace-nowrap opacity-0 group-hover:opacity-100 transition pointer-events-none z-10">
                                    {% if activity.is_active %}D√©sactiver{% else %}Activer{% endif %}
                                </div>
                            </form>




                            <div class="relative group">
                                <button data-url="{% url 'delete_activity' activity.id %}"
                                    onclick="openActivityDeleteModalFromData(this)"
                                    class="text-red-600 hover:text-red-800">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                                <div
                                    class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 px-2 py-1 rounded bg-gray-800 text-white text-xs whitespace-nowrap opacity-0 group-hover:opacity-100 transition pointer-events-none z-10">
                                    Supprimer
                                </div>
                            </div>


                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" class="text-center py-6 text-gray-500">Aucune activit√© trouv√©e.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- üìÑ Pagination -->
    <div class="flex justify-between items-center mt-6">
        <div class="text-sm text-gray-600">
            Page {{ page_obj.number }} sur {{ page_obj.paginator.num_pages }}
        </div>
        <div class="flex gap-1">
            {% if page_obj.has_previous %}
            <a href="?{% if search %}search={{ search }}&{% endif %}sort={{ sort }}&dir={{ direction }}&page={{ page_obj.previous_page_number }}"
                class="px-3 py-1 border rounded-lg text-sm hover:bg-gray-100">‚Üê Pr√©c√©dent</a>
            {% endif %}
            {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
            <span class="px-3 py-1 bg-green-500 text-white rounded-lg text-sm">{{ num }}</span>
            {% elif num > page_obj.number|add:'-2' and num < page_obj.number|add:'2' %} <a
                href="?{% if search %}search={{ search }}&{% endif %}sort={{ sort }}&dir={{ direction }}&page={{ num }}"
                class="px-3 py-1 border rounded-lg text-sm hover:bg-gray-100">{{ num }}</a>
                {% endif %}
                {% endfor %}
                {% if page_obj.has_next %}
                <a href="?{% if search %}search={{ search }}&{% endif %}sort={{ sort }}&dir={{ direction }}&page={{ page_obj.next_page_number }}"
                    class="px-3 py-1 border rounded-lg text-sm hover:bg-gray-100">Suivant ‚Üí</a>
                {% endif %}
        </div>
    </div>

</div>

<!-- ‚úÖ MODALE AJOUT ACTIVIT√â -->
<div id="addActivityModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-xl w-full max-w-lg shadow-lg">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Ajouter une activit√©</h2>
        <form method="post" action="{% url 'add_activity' %}" enctype="multipart/form-data" class="space-y-4">
            {% csrf_token %}
            <div>
                <label class="block text-sm text-gray-600">Titre</label>
                <input type="text" name="title" class="w-full border px-4 py-2 rounded-lg" required>
            </div>
            <div>
                <label class="block text-sm text-gray-600">Description</label>
                <textarea name="description" rows="3" class="w-full border px-4 py-2 rounded-lg" required></textarea>
            </div>
            <div>
                <label class="block text-sm text-gray-600">Vid√©o (URL)</label>
                <input type="url" name="video_url" class="w-full border px-4 py-2 rounded-lg">
            </div>
            <div>
                <label class="block text-sm text-gray-600">Image</label>
                <input type="file" name="image" accept="image/*" class="w-full border px-4 py-2 rounded-lg">
            </div>
            <div>
                <label class="block text-sm text-gray-600">Cat√©gorie</label>
                <select name="category" class="w-full border px-4 py-2 rounded-lg" required>
                    {% for cat in categories %}
                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="inline-flex items-center text-sm gap-2">
                    <input type="checkbox" name="is_active" class="h-4 w-4 text-green-500" checked>
                    Activit√© active
                </label>
            </div>
            <div class="flex justify-between mt-6">
                <button type="button" onclick="closeAddActivityModal()"
                    class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Annuler</button>
                <button type="submit"
                    class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">Ajouter</button>
            </div>
        </form>
    </div>
</div>



<!-- üß© Modale Modifier -->
<div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-xl w-full max-w-lg shadow-lg">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Modifier l'activit√©</h2>
        <form id="editForm" method="post" action="" enctype="multipart/form-data" class="space-y-4">
            {% csrf_token %}
            <input type="hidden" name="activity_id" id="edit_id">
            <div>
                <label class="block text-sm text-gray-600">Titre</label>
                <input type="text" name="title" id="edit_title" class="w-full border px-4 py-2 rounded-lg" required>
            </div>
            <div>
                <label class="block text-sm text-gray-600">Description</label>
                <textarea name="description" id="edit_description" rows="3"
                    class="w-full border px-4 py-2 rounded-lg"></textarea>
            </div>
            <div>
                <label class="block text-sm text-gray-600">Vid√©o (URL)</label>
                <input type="url" name="video_url" id="edit_video_url" class="w-full border px-4 py-2 rounded-lg">
            </div>
            <div id="edit_image_preview_container" class="mb-2 hidden">
                <label class="block text-sm text-gray-600 mb-1">Image actuelle</label>
                <img id="edit_image_preview" src="" alt="Image actuelle"
                    class="w-full max-h-40 object-contain rounded border">
            </div>
            <div>
                <label class="block text-sm text-gray-600">Image</label>
                <input type="file" name="image" accept="image/*" class="w-full border px-4 py-2 rounded-lg">
                <p class="text-xs text-gray-500 mt-1">Laisser vide pour conserver l'image actuelle.</p>
            </div>

            <div>
                <label class="block text-sm text-gray-600">Cat√©gorie</label>
                <select name="category" id="edit_category" class="w-full border px-4 py-2 rounded-lg">
                    {% for cat in categories %}
                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex justify-between mt-6">
                <button type="button" onclick="closeEditModal()"
                    class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Annuler</button>
                <button type="submit"
                    class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">Enregistrer</button>
            </div>
        </form>
    </div>
</div>

<!-- üî¥ MODALE DE SUPPRESSION ACTIVIT√â -->
<div id="activityDeleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-xl w-full max-w-md shadow-lg text-center">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Confirmer la suppression</h2>
        <p class="text-gray-600">Es-tu s√ªr de vouloir supprimer cette activit√© ? Cette action est irr√©versible.</p>
        <div class="mt-6 flex justify-center gap-4">
            <button onclick="closeActivityDeleteModal()"
                class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Annuler</button>
            <a id="confirmActivityDeleteBtn" href="#"
                class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">Supprimer</a>
        </div>
    </div>
</div>


<!-- üîß JS -->
<script>

    function openAddActivityModal() {
        document.getElementById('addActivityModal').classList.remove('hidden');
    }

    function closeAddActivityModal() {
        document.getElementById('addActivityModal').classList.add('hidden');
    }


    function openEditModalFromData(button) {
        const id = button.dataset.id;
        const title = button.dataset.title;
        const description = button.dataset.description;
        const video = button.dataset.video;
        const category = button.dataset.category;
        const imageUrl = button.dataset.image;

        document.getElementById('edit_id').value = id;
        document.getElementById('edit_title').value = title;
        document.getElementById('edit_description').value = description;
        document.getElementById('edit_video_url').value = video;
        document.getElementById('edit_category').value = category;

        // Pr√©remplir le champ image preview si dispo
        if (imageUrl && imageUrl !== "''") {
            document.getElementById('edit_image_preview').src = imageUrl;
            document.getElementById('edit_image_preview_container').classList.remove('hidden');
        } else {
            document.getElementById('edit_image_preview_container').classList.add('hidden');
        }

        document.getElementById('editForm').action = `/edit_activity/${id}/`;
        document.getElementById('editModal').classList.remove('hidden');
    }


    function closeEditModal() {
        document.getElementById('editModal').classList.add('hidden');
    }



    function closeEditModal() {
        document.getElementById('editModal').classList.add('hidden');
    }

    function openActivityDeleteModalFromData(button) {
        const url = button.dataset.url;
        document.getElementById('confirmActivityDeleteBtn').href = url;
        document.getElementById('activityDeleteModal').classList.remove('hidden');
    }


    function closeActivityDeleteModal() {
        document.getElementById('activityDeleteModal').classList.add('hidden');
    }
</script>
{% endblock %}